<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ProHelmet — Payment Successful</title>

  <style>
    :root{
      --bg:#070a10;
      --text:#e9eef7;
      --muted:#a9b4c6;
      --line:rgba(255,255,255,.10);
      --ok:#22c55e;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(1000px 600px at 50% 20%, rgba(45,76,140,.22), transparent 60%),
        radial-gradient(600px 400px at 20% 80%, rgba(0,200,255,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      padding:12px;
    }

    .wrap{ width:100%; max-width:420px; }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      position:relative;
    }

    .brand{ text-align:center; margin-bottom:8px; }
    .brand img{
      width:100%;
      max-width:380px;
      height:60px;
      object-fit:contain;
    }

    .caption{
      text-align:center;
      font-weight:700;
      font-size:18px;
      margin-bottom:12px;
    }

    .divider{ height:1px; background:var(--line); margin-bottom:16px; }

    .check{
      width:62px;
      height:62px;
      margin:0 auto 10px auto;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.28);
    }
    .check svg{ width:34px; height:34px; fill:var(--ok); }

    .title{
      text-align:center;
      font-size:26px;
      font-weight:900;
      margin:0 0 6px 0;
    }

    .pill{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      font-weight:800;
      margin-bottom:14px;
      text-align:center;
      word-break:break-all;
    }

    .info{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      margin-bottom:14px;
    }

    .note{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      font-size:13px;
      color:var(--muted);
      margin-bottom:14px;
    }

    .wa{ text-align:center; font-weight:900; margin-top:10px; }
    .wa2{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      font-size:20px;
      font-weight:900;
      margin-top:6px;
    }

    .wa-link{ color:#25D366; text-decoration:none; font-weight:900; }
    .wa-link:hover{ text-decoration:underline; }

    /* Click reliability */
    .feedback-card{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      margin-bottom:16px;
      text-align:center;
      position:relative;
      z-index:9999;
      pointer-events:auto;
    }

    .feedback-title{ font-weight:900; margin-bottom:4px; }
    .feedback-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:12px;
    }

    .stars{
      display:flex;
      justify-content:center;
      gap:8px;
      font-size:28px;
      position:relative;
      z-index:10000;
      pointer-events:auto;
    }

    .star{
      display:inline-block;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      color:#555;
      transition:color .2s ease;
      position:relative;
      z-index:10001;
      pointer-events:auto;
    }

    .star.active{ color:#facc15; }

    .feedback-text{
      width:100%;
      margin-top:12px;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.4);
      color:var(--text);
      resize:none;
      position:relative;
      z-index:10000;
      pointer-events:auto;
    }

    .feedback-submit{
      margin-top:10px;
      padding:10px 16px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      display:inline-block;
      position:relative;
      z-index:10000;
      pointer-events:auto;
    }

    .btn{
      display:block;
      text-align:center;
      padding:16px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      font-weight:800;
      text-decoration:none;
      color:var(--text);
      margin-bottom:12px;
      position:relative;
      z-index:1;
    }

    .footer{
      text-align:center;
      font-size:12px;
      color:rgba(233,238,247,.55);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="brand">
        <img src="brand_header123.png" alt="PROHELMET">
      </div>

      <div class="caption">Stay Safe. Stay Fresh.</div>
      <div class="divider"></div>

      <div class="check">
        <svg viewBox="0 0 24 24">
          <path d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
        </svg>
      </div>

      <div class="title">Payment Successful</div>

      <div class="pill">
        <span>Txn ID:</span>
        <b id="txnText">—</b>
      </div>

      <div class="info">Your helmet is now in the sanitization cycle.</div>

      <div class="note">
        If you encounter any issues with <b>payment</b> or the <b>cleaning cycle</b>,
        please reachout to us with your payment screenshot and we will assist you on priority.

        <div class="wa">Message us at WhatsApp:</div>

        <div class="wa2">
          <a id="waLink"
             class="wa-link"
             href="https://wa.me/917207400693"
             target="_blank"
             rel="noopener">
             7207400693
          </a>
        </div>
      </div>

      <!-- Feedback Section -->
      <div class="feedback-card" id="feedbackCard">
        <div class="feedback-title">We are new. Help us improve.</div>
        <div class="feedback-sub">Kindly give your words of encouragement.</div>

        <div class="stars" id="starContainer">
          <span class="star" data-value="1">★</span>
          <span class="star" data-value="2">★</span>
          <span class="star" data-value="3">★</span>
          <span class="star" data-value="4">★</span>
          <span class="star" data-value="5">★</span>
        </div>

        <textarea id="feedbackText"
                  class="feedback-text"
                  placeholder="Write your feedback..."
                  style="display:none;"></textarea>

        <button id="feedbackSubmit"
                class="feedback-submit"
                style="display:none;"
                type="button"
                onclick="submitFeedback()">
          Submit Feedback
        </button>
      </div>

      <a class="btn" href="https://prohelmet0210.github.io/Website/" target="_blank">
        Visit Official Website
      </a>

      <div class="footer">©PROHELMET</div>

    </div>
  </div>

<script>
  // ✅ your Apps Script URL
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxJ_I1l0sLymAi0945LhLLcbwbzwrNf4BDLMKge5Un3QW9R3rmgigfCfzgRELh7dHpEDQ/exec";

  const params = new URLSearchParams(window.location.search);

  function getParam(keys) {
    for (const key of keys) {
      const v = (params.get(key) || "").trim();
      if (v) return v;
    }
    return "";
  }

  const txnId = getParam([
    "razorpay_payment_link_id",
    "plink",
    "razorpay_payment_id"
  ]) || "—";

  // ✅ Kiosk ID extraction (scalable):
  // Priority:
  // 1) kiosk_id param
  // 2) kiosk param
  // 3) parse from razorpay_payment_link_reference_id (format: prohelmet|KIOSK_ID|anything)
  function extractKioskId() {
    const direct = getParam(["kiosk_id", "kiosk"]);
    if (direct) return direct;

    const ref = (params.get("razorpay_payment_link_reference_id") || "").trim();
    if (ref) {
      // expected format: prohelmet|PH-IND-HYD-A101|1771834196
      const parts = ref.split("|").map(x => (x || "").trim()).filter(Boolean);
      if (parts.length >= 2) return parts[1]; // the kiosk id
    }
    return "UNKNOWN";
  }

  const kioskId = extractKioskId();

  // Render Txn ID
  const txnEl = document.getElementById("txnText");
  if (txnEl) txnEl.textContent = txnId;

  // WhatsApp deep link with Txn
  const waLink = document.getElementById("waLink");
  if (waLink) {
    const base = "https://wa.me/917207400693?text=";
    const msg = txnId === "—"
      ? "Hi ProHelmet, I need help with my payment/cleaning cycle."
      : `Hi ProHelmet, I need help with my payment/cleaning cycle. Txn: ${txnId}`;
    waLink.href = base + encodeURIComponent(msg);
  }

  let selectedRating = 0;

  const stars = document.querySelectorAll(".star");
  const feedbackText = document.getElementById("feedbackText");
  const feedbackSubmit = document.getElementById("feedbackSubmit");
  const feedbackCard = document.getElementById("feedbackCard");

  function sendToSheet(rating, feedback) {
    if (!txnId || txnId === "—") return Promise.resolve();

    const qs = new URLSearchParams({
      txn_id: txnId,
      kiosk_id: kioskId,
      rating: String(rating || ""),
      feedback: (feedback || "")
    });

    const url = APPS_SCRIPT_URL + "?" + qs.toString() + "&_ts=" + Date.now();

    return fetch(url)
      .then(res => res.text())
      .catch(() => "");
  }

  // Star click -> highlight + show input + auto record rating
  stars.forEach(star => {
    star.addEventListener("click", () => {
      selectedRating = parseInt(star.dataset.value, 10) || 0;

      stars.forEach(s => {
        s.classList.toggle("active", (parseInt(s.dataset.value, 10) || 0) <= selectedRating);
      });

      feedbackText.style.display = "block";
      feedbackSubmit.style.display = "inline-block";

      sendToSheet(selectedRating, "");
    });

    star.addEventListener("touchstart", (e) => { e.preventDefault(); star.click(); }, { passive:false });
  });

  // Submit -> send comment then switch UI
  window.submitFeedback = function submitFeedback() {
    const txt = (feedbackText.value || "").trim();

    sendToSheet(selectedRating || 0, txt).finally(() => {
      feedbackCard.innerHTML = `
        <div style="font-weight:900;font-size:18px;padding:20px 10px;">
          Thank you for submitting your feedback!
        </div>
      `;
    });
  };
</script>

</body>
</html>

